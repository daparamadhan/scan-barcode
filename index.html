<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Security QR Tool</title>
    <!-- 1. Include Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. Include QR Code LIBRARIES -->
    <!-- This is the SCANNER library (unchanged) -->
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    
    <!-- Replaced the old qrcode.js with the modern qrcode (v1.4.4) library -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.4.4/build/qrcode.min.js"></script>
    
    <style>
        /* Hide elements by default */
        .hidden {
            display: none;
        }
        /* Scanner video styles */
        #reader {
            border: 2px dashed #0891b2; /* cyan-600 */
            border-radius: 8px;
        }
        #reader video {
            width: 100%;
            height: auto;
            border-radius: 6px;
        }
        #reader__scan_region {
            border-color: rgba(255, 255, 255, 0.5) !important;
            background: none !important;
        }
        /* Generated QR code styles */
        #qrcode-display {
            width: 264px; /* Container size */
            height: 264px;
            background: white;
            padding: 8px; /* This creates the "quiet zone" border */
            border-radius: 8px;
            margin-left: auto;
            margin-right: auto;
        }
        /* The new img tag will fill the container's content-box (248px) */
        #qrcode-display img {
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen font-sans flex items-center justify-center py-6">

    <div class="container max-w-lg w-full mx-auto p-6 bg-gray-800 rounded-lg shadow-2xl relative">

        <h1 class="text-3xl font-bold text-center text-cyan-400 mb-6">
            Security QR Tool
        </h1>

        <!-- 3. Tab Navigation -->
        <div class="flex w-full rounded-lg bg-gray-700 p-1 mb-6">
            <button id="scan-tab-btn" class="flex-1 py-2 px-4 rounded-md text-white font-semibold bg-cyan-600 transition-all">
                Scan
            </button>
            <button id="create-tab-btn" class="flex-1 py-2 px-4 rounded-md text-gray-300 font-semibold transition-all">
                Create
            </button>
        </div>

        <!-- 4. App Content Area -->
        <div id="app-content">

            <!-- ======================= -->
            <!--   SCANNER PAGE          -->
            <!-- ======================= -->
            <div id="scan-page">
                <div id="reader" class="w-full aspect-square overflow-hidden bg-gray-700">
                    <!-- Camera feed goes here -->
                </div>

                <div class="grid grid-cols-2 gap-4 mt-6">
                    <button id="start-btn" class="w-full bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-3 px-4 rounded-lg transition duration-200 shadow-md">
                        Start Scan
                    </button>
                    <button id="stop-btn" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-4 rounded-lg transition duration-200 shadow-md">
                        Stop Scan
                    </button>
                </div>

                <div class="mt-6">
                    <div class="mb-4">
                        <p class="font-medium text-gray-400">Status:</p>
                        <p id="status" class="text-lg text-yellow-400 font-mono p-3 bg-gray-900 rounded-md min-h-[1.5em]">
                            Scanner is idle.
                        </p>
                    </div>
                    <div>
                        <p class="font-medium text-gray-400">Result:</p>
                        <p id="result" class="text-lg text-green-400 font-mono p-3 bg-gray-900 rounded-md break-words min-h-[1.5em]">
                            <!-- Scanned result will appear here -->
                        </p>
                    </div>
                </div>
            </div>

            <!-- ======================= -->
            <!--   GENERATOR PAGE        -->
            <!-- ======================= -->
            <div id="create-page" class="hidden">
                <div class="w-full">
                    <label for="qr-text-input" class="font-medium text-gray-400 mb-2 block">
                        Enter your secret text, URL, or password:
                    </label>
                    <textarea id="qr-text-input" rows="4" class="w-full p-3 bg-gray-900 rounded-md text-white font-mono border border-gray-700 focus:border-cyan-500 focus:ring-0"></textarea>
                    
                    <button id="generate-btn" class="w-full bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-3 px-4 rounded-lg transition duration-200 shadow-md mt-4">
                        Generate QR Code
                    </button>

                    <div id="qrcode-display" class="mt-6 hidden">
                        <!-- A clean <img /> will be put here by the new library -->
                    </div>
                    <p id="save-note" class="text-center text-gray-400 text-sm mt-4 hidden">
                        Right-click or long-press the QR code to save it.
                    </p>
                </div>
            </div>

        </div>
    </div>

    <!-- ======================= -->
    <!--   MODAL POP-UP          -->
    <!-- ======================= -->
    <div id="modal-overlay" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 flex">
        <div class="bg-gray-800 p-6 rounded-lg shadow-xl max-w-sm w-full mx-4 border border-gray-700">
            <h3 id="modal-title" class="text-xl font-bold text-red-500 mb-2">Error</h3>
            <p id="modal-message" class="text-gray-300 mb-6">
                Something went wrong.
            </p>
            <button id="modal-close-btn" class="w-full bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2 px-4 rounded transition duration-200">
                Close
            </button>
        </div>
    </div>

    <!-- 5. The JavaScript Logic -->
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            
            // --- Global App Elements ---
            const scanTabBtn = document.getElementById("scan-tab-btn");
            const createTabBtn = document.getElementById("create-tab-btn");
            const scanPage = document.getElementById("scan-page");
            const createPage = document.getElementById("create-page");

            // --- Modal Elements ---
            const modalOverlay = document.getElementById("modal-overlay");
            const modalTitle = document.getElementById("modal-title");
            const modalMessage = document.getElementById("modal-message");
            const modalCloseBtn = document.getElementById("modal-close-btn");

            // --- Modal Functions ---
            function showModal(title, message) {
                modalTitle.textContent = title;
                modalMessage.textContent = message;
                modalOverlay.classList.remove("hidden");
            }

            function hideModal() {
                modalOverlay.classList.add("hidden");
            }

            modalCloseBtn.addEventListener("click", hideModal);
            // Close modal when clicking outside the content box
            modalOverlay.addEventListener("click", (e) => {
                if (e.target === modalOverlay) {
                    hideModal();
                }
            });

            // --- Audio Beep Setup ---
            let audioContext;
            function initAudioContext() {
                if (!audioContext) {
                    try {
                        audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    } catch (e) {
                        console.warn("Web Audio API is not supported in this browser");
                    }
                }
            }
            function playBeep() {
                if (!audioContext) return;
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                gainNode.gain.setValueAtTime(0, audioContext.currentTime);
                gainNode.gain.linearRampToValueAtTime(0.5, audioContext.currentTime + 0.01);
                oscillator.frequency.setValueAtTime(880, audioContext.currentTime);
                oscillator.type = 'sine';
                oscillator.start(audioContext.currentTime);
                gainNode.gain.linearRampToValueAtTime(0, audioContext.currentTime + 0.1);
                oscillator.stop(audioContext.currentTime + 0.1);
            }

            // --- Scanner Logic ---
            const readerEl = document.getElementById("reader");
            const startBtn = document.getElementById("start-btn");
            const stopBtn = document.getElementById("stop-btn");
            const statusEl = document.getElementById("status");
            const resultEl = document.getElementById("result");
            const qrTextInput = document.getElementById("qr-text-input");

            const formatsToSupport = [ Html5QrcodeSupportedFormats.QR_CODE ];
            const html5QrCode = new Html5Qrcode("reader", {
                formatsToSupport: formatsToSupport,
                verbose: false
            });

            const onScanSuccess = (decodedText, decodedResult) => {
                playBeep();
                stopScan();

                // Check if the scanned text is a web URL
                if (decodedText.startsWith("http://") || decodedText.startsWith("https://")) {
                    // It is a URL, redirect the browser
                    statusEl.textContent = "Scan Successful. Redirecting...";
                    resultEl.textContent = decodedText;
                    window.location.href = decodedText;
                } else {
                    // It is NOT a URL, show the pop-up modal
                    statusEl.textContent = "Scan finished.";
                    resultEl.textContent = "Invalid content scanned.";
                    showModal("Invalid QR Code", "error, contact our staff");
                }
            };

            const config = {
                fps: 10,
                qrbox: (w, h) => ({ width: Math.floor(Math.min(w, h) * 0.8), height: Math.floor(Math.min(w, h) * 0.8) })
            };

            function startScan() {
                initAudioContext();
                statusEl.textContent = "Requesting camera access...";
                resultEl.textContent = "";
                html5QrCode.start(
                    { facingMode: "environment" }, config,
                    onScanSuccess, 
                    (errorMessage) => { /* Ignore non-finding errors */ }
                ).then(() => {
                    statusEl.textContent = "Scanning... Point camera at a QR code.";
                }).catch((err) => {
                    statusEl.textContent = `Error: ${err}`;
                    showModal("Camera Error", "Could not access camera. Please ensure you have granted permission.");
                });
            }

            function stopScan() {
                try {
                    html5QrCode.stop();
                    statusEl.textContent = "Scanner stopped.";
                } catch (err) {
                    if (statusEl.textContent.startsWith("Scanning")) {
                         statusEl.textContent = "Scanner stopped.";
                    }
                }
            }
            startBtn.addEventListener('click', startScan);
            stopBtn.addEventListener('click', stopScan);


            // --- Generator Logic ---
            const generateBtn = document.getElementById("generate-btn");
            const qrcodeDisplay = document.getElementById("qrcode-display");
            const saveNote = document.getElementById("save-note");
            
            generateBtn.addEventListener('click', () => {
                const text = qrTextInput.value;
                if (!text) {
                    return; // Don't generate if input is empty
                }

                // Options for the QR code generator
                const options = {
                    errorCorrectionLevel: 'medium', // 'M' - good balance
                    type: 'image/png', // We want a PNG
                    width: 248, // This will fit perfectly inside our 264px div with 8px padding
                    margin: 1 // A small 1-module quiet zone (library adds it)
                };

                // Use the new library to generate a Data URL
                QRCode.toDataURL(text, options, function (err, url) {
                    if (err) {
                        console.error(err);
                        showModal("Generator Error", "Could not generate QR code.");
                        return;
                    }

                    // Clear previous QR code
                    qrcodeDisplay.innerHTML = "";
                    
                    // Create a new <img> element
                    const img = document.createElement('img');
                    img.src = url;
                    
                    // Add the new image to the display div
                    qrcodeDisplay.appendChild(img);

                    // Show the display div and save note
                    qrcodeDisplay.classList.remove("hidden");
                    saveNote.classList.remove("hidden");
                });
            });

            // --- Tab Switching Logic ---
            scanTabBtn.addEventListener('click', () => {
                scanPage.classList.remove("hidden");
                createPage.classList.add("hidden");
                scanTabBtn.classList.add("bg-cyan-600", "text-white");
                scanTabBtn.classList.remove("text-gray-300");
                createTabBtn.classList.add("text-gray-300");
                createTabBtn.classList.remove("bg-cyan-600", "text-white");
            });

            createTabBtn.addEventListener('click', () => {
                stopScan(); // CRITICAL: Stop scanner when switching tabs
                createPage.classList.remove("hidden");
                scanPage.classList.add("hidden");
                createTabBtn.classList.add("bg-cyan-600", "text-white");
                createTabBtn.classList.remove("text-gray-300");
                scanTabBtn.classList.add("text-gray-300");
                scanTabBtn.classList.remove("bg-cyan-600", "text-white");
            });

        });
    </script>

</body>
</html>